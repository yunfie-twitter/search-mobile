<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="description" content="Wholphin Search - プライバシーを重視した検索エンジン">
    <meta name="theme-color" content="#007AFF">
    <title>Wholphin Search</title>
    
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%23007AFF'/%3E%3Cpath d='M30 45 Q50 30 70 45 T70 65 Q50 80 30 65 Z' fill='white'/%3E%3C/svg%3E">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%23007AFF'/%3E%3Cpath d='M30 45 Q50 30 70 45 T70 65 Q50 80 30 65 Z' fill='white'/%3E%3C/svg%3E">
    
    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/fonts.css">
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/layout.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/utilities.css">
    <link rel="stylesheet" href="css/desktop.css">
    <link rel="stylesheet" href="css/advanced-features.css">
    <link rel="stylesheet" href="css/start-page.css">
    <link rel="stylesheet" href="css/settings-page.css">
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@studio-freight/lenis@1.0.29/bundled/lenis.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/ScrollTrigger.min.js"></script>
</head>
<body>
    <div id="app">
        <!-- Desktop Sidebar -->
        <aside class="desktop-sidebar" v-show="currentView !== 'settings'">
            <div class="sidebar-logo">
                <div class="sidebar-logo-icon">
                    <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="50" cy="50" r="45" fill="currentColor" opacity="0.1"/>
                        <path d="M30 45 Q50 30 70 45 T70 65 Q50 80 30 65 Z" fill="currentColor"/>
                    </svg>
                </div>
                <h1 class="sidebar-logo-text">Wholphin</h1>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-section-title">検索タイプ</div>
                <button 
                    v-for="type in searchTypes" 
                    :key="type.value"
                    @click="changeSearchType(type.value)"
                    :class="['sidebar-nav-item', { 'active': currentType === type.value && currentView === 'search' }]"
                >
                    <div class="sidebar-nav-icon" v-html="type.icon"></div>
                    <span class="sidebar-nav-label">{{ type.label }}</span>
                </button>
            </div>

            <div class="sidebar-divider"></div>

            <div class="sidebar-section">
                <button 
                    @click="toggleSettings"
                    :class="['sidebar-nav-item', { 'active': currentView === 'settings' }]"
                >
                    <div class="sidebar-nav-icon">
                        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="10" cy="10" r="3"></circle>
                            <path d="M10 1v3m0 6v3M4.7 4.7l2.1 2.1m4.2 4.2l2.1 2.1M1 10h3m6 0h3M4.7 15.3l2.1-2.1m4.2-4.2l2.1-2.1"></path>
                        </svg>
                    </div>
                    <span class="sidebar-nav-label">設定</span>
                </button>
            </div>
        </aside>

        <!-- Desktop Main -->
        <div class="desktop-main">
            <!-- Tab Bar (Desktop) -->
            <div class="tab-bar-container" v-show="currentView !== 'settings'">
                <button 
                    v-for="tab in tabs" 
                    :key="tab.id"
                    @click="switchTab(tab.id)"
                    :class="['search-tab', { 'active': activeTabId === tab.id }]"
                >
                    <span class="search-tab-label">{{ tab.title }}</span>
                    <button 
                        v-if="tabs.length > 1"
                        class="search-tab-close"
                        @click.stop="closeTab(tab.id)"
                    >
                        <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 3L3 9M3 3l6 6"/>
                        </svg>
                    </button>
                </button>
                <button class="tab-new" @click="createNewTab" title="新しいタブ">
                    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M8 3v10M3 8h10"/>
                    </svg>
                </button>
            </div>

            <!-- Start Page -->
            <transition name="fade-page">
                <div v-if="currentView === 'start'" class="start-page">
                    <div class="start-container">
                        <div class="start-logo-section">
                            <div class="start-logo-icon">
                                <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <circle cx="50" cy="50" r="45" fill="currentColor" opacity="0.1"/>
                                    <path d="M30 45 Q50 30 70 45 T70 65 Q50 80 30 65 Z" fill="currentColor"/>
                                </svg>
                            </div>
                            <h1 class="start-logo-text">Wholphin</h1>
                            <p class="start-tagline">プライバシー第一の検索体験</p>
                        </div>

                        <div class="start-search-section">
                            <div class="start-search-box">
                                <div class="start-search-icon">
                                    <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                        <circle cx="11" cy="11" r="8"></circle>
                                        <path d="m21 21-4.35-4.35"></path>
                                    </svg>
                                </div>
                                <input 
                                    type="search" 
                                    class="start-search-input" 
                                    v-model="query"
                                    @keyup.enter="performSearchFromStart"
                                    @focus="handleStartSearchFocus"
                                    @blur="handleSearchBlur"
                                    placeholder="何でも検索"
                                    aria-label="検索"
                                    autocomplete="off"
                                    ref="startSearchInput"
                                >
                            </div>

                            <!-- Start Page Suggestions -->
                            <transition name="slide-fade">
                                <div v-if="showSuggestions && suggestions.length > 0" class="start-suggestions">
                                    <button 
                                        v-for="(suggestion, index) in suggestions" 
                                        :key="index"
                                        @mousedown.prevent="selectSuggestion(suggestion)"
                                        class="start-suggestion-item"
                                    >
                                        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <circle cx="11" cy="11" r="8"></circle>
                                            <path d="m21 21-4.35-4.35"></path>
                                        </svg>
                                        <span>{{ suggestion }}</span>
                                    </button>
                                </div>
                            </transition>
                        </div>

                        <!-- Quick Links -->
                        <div class="start-quick-links" v-if="searchHistory.length > 0">
                            <h3 class="start-section-title">最近の検索</h3>
                            <div class="start-history-grid">
                                <button 
                                    v-for="(item, index) in searchHistory.slice(0, 6)" 
                                    :key="index"
                                    @click="selectHistory(item)"
                                    class="start-history-card"
                                >
                                    <div class="start-history-icon">
                                        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                                            <circle cx="10" cy="10" r="8"></circle>
                                            <polyline points="10 5 10 10 13 12"/>
                                        </svg>
                                    </div>
                                    <div class="start-history-text">
                                        <div class="start-history-query">{{ item.query }}</div>
                                        <div class="start-history-type">{{ getTypeLabel(item.type) }}</div>
                                    </div>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </transition>

            <!-- Settings Page -->
            <transition name="fade-page">
                <div v-if="currentView === 'settings'" class="settings-page">
                    <div class="settings-container">
                        <div class="settings-header">
                            <button class="settings-back" @click="closeSettings">
                                <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="15 18 9 12 15 6"></polyline>
                                </svg>
                            </button>
                            <h1 class="settings-title">設定</h1>
                        </div>

                        <div class="settings-content">
                            <section class="settings-section">
                                <h2 class="settings-section-title">検索</h2>
                                <div class="settings-card-group">
                                    <div class="settings-item">
                                        <div class="settings-item-info">
                                            <label class="settings-item-label">セーフサーチ</label>
                                            <p class="settings-item-description">不適切なコンテンツをフィルタリング</p>
                                        </div>
                                        <select v-model.number="safesearch" class="settings-input">
                                            <option :value="0">無効</option>
                                            <option :value="1">標準</option>
                                            <option :value="2">厳格</option>
                                        </select>
                                    </div>
                                    <div class="settings-divider"></div>
                                    <div class="settings-item">
                                        <div class="settings-item-info">
                                            <label class="settings-item-label">検索言語</label>
                                            <p class="settings-item-description">優先する検索結果の言語</p>
                                        </div>
                                        <select v-model="language" class="settings-input">
                                            <option value="ja">日本語</option>
                                            <option value="en">English</option>
                                        </select>
                                    </div>
                                </div>
                            </section>

                            <section class="settings-section">
                                <h2 class="settings-section-title">表示</h2>
                                <div class="settings-card-group">
                                    <div class="settings-item">
                                        <div class="settings-item-info">
                                            <label class="settings-item-label">表示密度</label>
                                            <p class="settings-item-description">検索結果の表示サイズ</p>
                                        </div>
                                        <select v-model="density" class="settings-input">
                                            <option value="compact">コンパクト</option>
                                            <option value="normal">標準</option>
                                            <option value="comfortable">快適</option>
                                        </select>
                                    </div>
                                    <div class="settings-divider"></div>
                                    <div class="settings-item">
                                        <div class="settings-item-info">
                                            <label class="settings-item-label">アニメーション</label>
                                            <p class="settings-item-description">滑らかな動きと効果</p>
                                        </div>
                                        <label class="settings-toggle">
                                            <input type="checkbox" v-model="animationsEnabled">
                                            <span class="settings-toggle-slider"></span>
                                        </label>
                                    </div>
                                </div>
                            </section>

                            <section class="settings-section">
                                <h2 class="settings-section-title">プライバシー</h2>
                                <div class="settings-card-group">
                                    <div class="settings-item">
                                        <div class="settings-item-info">
                                            <label class="settings-item-label">検索履歴</label>
                                            <p class="settings-item-description">{{ searchHistory.length }}件の履歴が保存されています</p>
                                        </div>
                                        <button class="settings-button-danger" @click="clearHistoryConfirm">クリア</button>
                                    </div>
                                    <div class="settings-divider"></div>
                                    <div class="settings-item">
                                        <div class="settings-item-info">
                                            <label class="settings-item-label">検索候補</label>
                                            <p class="settings-item-description">入力中に候補を表示</p>
                                        </div>
                                        <label class="settings-toggle">
                                            <input type="checkbox" v-model="suggestionsEnabled">
                                            <span class="settings-toggle-slider"></span>
                                        </label>
                                    </div>
                                </div>
                            </section>

                            <section class="settings-section">
                                <h2 class="settings-section-title">情報</h2>
                                <div class="settings-card-group">
                                    <div class="settings-item">
                                        <div class="settings-item-info">
                                            <label class="settings-item-label">バージョン</label>
                                            <p class="settings-item-description">Wholphin Search 2.0</p>
                                        </div>
                                    </div>
                                </div>
                            </section>
                        </div>
                    </div>
                </div>
            </transition>

            <!-- Search View -->
            <transition name="fade-page">
                <div v-if="currentView === 'search'" class="search-view">
                    <!-- Header -->
                    <header class="mobile-header" :class="{ 'header-compact': searchPerformed }">
                        <div class="logo-container">
                            <div class="logo-icon">
                                <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <circle cx="50" cy="50" r="45" fill="currentColor" opacity="0.1"/>
                                    <path d="M30 45 Q50 30 70 45 T70 65 Q50 80 30 65 Z" fill="currentColor"/>
                                </svg>
                            </div>
                            <h1 class="logo-text">Wholphin</h1>
                        </div>

                        <div class="desktop-toolbar">
                            <div class="search-box-wrapper">
                                <div class="search-box">
                                    <input 
                                        type="search" 
                                        class="search-input" 
                                        v-model="query"
                                        @input="handleSearchInput"
                                        @keyup.enter="performSearch"
                                        @focus="handleSearchFocus"
                                        @blur="handleSearchBlur"
                                        placeholder="検索"
                                        aria-label="検索"
                                        autocomplete="off"
                                    >
                                    <button class="search-button" @click="performSearch" aria-label="検索実行">
                                        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                            <circle cx="11" cy="11" r="8"></circle>
                                            <path d="m21 21-4.35-4.35"></path>
                                        </svg>
                                    </button>
                                </div>
                                
                                <!-- Suggestions -->
                                <transition name="slide-down">
                                    <div v-if="showSuggestions && suggestions.length > 0" class="suggestions-dropdown">
                                        <button 
                                            v-for="(suggestion, index) in suggestions" 
                                            :key="index"
                                            @mousedown.prevent="selectSuggestion(suggestion)"
                                            class="suggestion-item"
                                        >
                                            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="suggestion-icon">
                                                <circle cx="11" cy="11" r="8"></circle>
                                                <path d="m21 21-4.35-4.35"></path>
                                            </svg>
                                            <span>{{ suggestion }}</span>
                                        </button>
                                    </div>
                                </transition>

                                <!-- Search History -->
                                <transition name="slide-down">
                                    <div v-if="showHistory && searchHistory.length > 0" class="search-history-dropdown">
                                        <div class="history-section">
                                            <div class="history-section-title">最近の検索</div>
                                            <button 
                                                v-for="(item, index) in searchHistory" 
                                                :key="index"
                                                class="history-item"
                                                @click="selectHistory(item)"
                                            >
                                                <svg class="history-icon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                                    <circle cx="12" cy="12" r="10"/>
                                                    <polyline points="12 6 12 12 16 14"/>
                                                </svg>
                                                <div class="history-text">
                                                    <div class="history-query">{{ item.query }}</div>
                                                    <div class="history-meta">{{ formatTimestamp(item.timestamp) }} · {{ getTypeLabel(item.type) }}</div>
                                                </div>
                                                <button class="history-delete" @click.stop="deleteHistory(item.query)">
                                                    <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2">
                                                        <path d="M12 4L4 12M4 4l8 8"/>
                                                    </svg>
                                                </button>
                                            </button>
                                        </div>
                                        <button class="history-clear" @click="clearHistory">履歴をクリア</button>
                                    </div>
                                </transition>
                            </div>

                            <div class="toolbar-group">
                                <button 
                                    v-for="view in viewModes" 
                                    :key="view.value"
                                    @click="viewMode = view.value"
                                    :class="['toolbar-button', { 'active': viewMode === view.value }]"
                                    :title="view.label"
                                >
                                    <div class="toolbar-icon" v-html="view.icon"></div>
                                </button>
                            </div>

                            <div class="toolbar-divider"></div>

                            <button class="toolbar-button" @click="toggleSettings" title="設定">
                                <div class="toolbar-icon">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <circle cx="8" cy="8" r="2"></circle>
                                        <path d="M8 1v2m0 6v2M3.9 3.9l1.4 1.4m4.2 4.2l1.4 1.4M1 8h2m6 0h2M3.9 12.1l1.4-1.4m4.2-4.2l1.4-1.4"></path>
                                    </svg>
                                </div>
                            </button>
                        </div>
                    </header>

                    <!-- Content -->
                    <div class="desktop-content">
                        <main class="main-content">
                            <div class="container">
                                <div v-if="loading" class="content-area">
                                    <div class="stack">
                                        <div class="skeleton-result" v-for="i in 3" :key="i">
                                            <div class="skeleton-header">
                                                <div class="skeleton skeleton-favicon"></div>
                                                <div class="skeleton skeleton-title"></div>
                                            </div>
                                            <div class="skeleton skeleton-description"></div>
                                            <div class="skeleton skeleton-url"></div>
                                        </div>
                                    </div>
                                </div>

                                <div v-if="error" class="alert alert-warning content-area">
                                    <div class="alert-icon">
                                        <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                                            <line x1="12" y1="9" x2="12" y2="13"></line>
                                            <line x1="12" y1="17" x2="12.01" y2="17"></line>
                                        </svg>
                                    </div>
                                    <div>
                                        <strong>問題が発生しました</strong>
                                        <p class="alert-message">{{ error }}</p>
                                    </div>
                                </div>

                                <transition name="fade" mode="out-in">
                                    <div v-if="!loading && results.length > 0" :key="currentType" :class="['results-container', 'content-area', 'density-' + density]">
                                        <div v-if="currentType === 'web'" class="stack-web">
                                            <article v-for="(item, index) in results" :key="index" class="result-card" @contextmenu.prevent="showContextMenuFor(item, $event)">
                                                <a :href="item.url" target="_blank" rel="noopener noreferrer" class="result-link">
                                                    <div class="result-header">
                                                        <img 
                                                            v-if="item.favicon" 
                                                            :src="item.favicon" 
                                                            :alt="item.title + ' favicon'"
                                                            class="result-favicon"
                                                            loading="lazy"
                                                            @error="handleFaviconError($event)"
                                                        >
                                                        <div class="result-favicon-fallback" v-else>
                                                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                                                <path d="M8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0zM4.5 7.5a.5.5 0 0 1 0-1h5.793L8.146 4.354a.5.5 0 1 1 .708-.708l3 3a.5.5 0 0 1 0 .708l-3 3a.5.5 0 0 1-.708-.708L10.293 7.5H4.5z"/>
                                                            </svg>
                                                        </div>
                                                        <h3 class="result-title">{{ item.title }}</h3>
                                                    </div>
                                                    <p class="result-description">{{ item.summary || item.description }}</p>
                                                    <p class="result-domain">{{ extractDomain(item.url) }}</p>
                                                </a>
                                            </article>
                                        </div>

                                        <div v-if="currentType === 'image'" class="image-grid">
                                            <a v-for="(item, index) in results" :key="index" :href="item.url" target="_blank" rel="noopener noreferrer" class="image-item">
                                                <div class="image-wrapper">
                                                    <img :src="item.thumbnail" :alt="item.title" class="image-thumb" loading="lazy">
                                                </div>
                                                <p class="image-title">{{ item.title }}</p>
                                            </a>
                                        </div>

                                        <div v-if="currentType === 'video'" class="stack-video">
                                            <article v-for="(item, index) in results" :key="index" class="result-card">
                                                <a :href="item.url" target="_blank" rel="noopener noreferrer" class="result-link">
                                                    <div v-if="item.thumbnail" class="video-thumbnail">
                                                        <img :src="item.thumbnail" :alt="item.title" loading="lazy">
                                                        <div class="video-overlay">
                                                            <svg width="24" height="24" fill="white" viewBox="0 0 16 16">
                                                                <path d="M10.804 8 5 4.633v6.734L10.804 8z"/>
                                                            </svg>
                                                        </div>
                                                    </div>
                                                    <h3 class="result-title-video">{{ item.title }}</h3>
                                                    <p class="result-description">{{ item.summary || item.description }}</p>
                                                    <div class="video-meta" v-if="item.duration || item.views">
                                                        <span v-if="item.duration" class="meta-badge">{{ item.duration }}</span>
                                                        <span v-if="item.views" class="meta-badge">{{ formatViews(item.views) }} 回視聴</span>
                                                    </div>
                                                    <button v-if="currentType === 'video'" class="pip-button" @click.prevent="togglePiP(item)">
                                                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                                            <path d="M0 3.5A1.5 1.5 0 0 1 1.5 2h13A1.5 1.5 0 0 1 16 3.5v9a1.5 1.5 0 0 1-1.5 1.5h-13A1.5 1.5 0 0 1 0 12.5v-9zM1.5 3a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h13a.5.5 0 0 0 .5-.5v-9a.5.5 0 0 0-.5-.5h-13z"/>
                                                            <path d="M8 8.5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 .5.5v3a.5.5 0 0 1-.5.5h-5a.5.5 0 0 1-.5-.5v-3z"/>
                                                        </svg>
                                                        PiP
                                                    </button>
                                                </a>
                                            </article>
                                        </div>

                                        <div v-if="currentType === 'news'" class="stack-news">
                                            <article v-for="(item, index) in results" :key="index" class="result-card">
                                                <a :href="item.url" target="_blank" rel="noopener noreferrer" class="result-link">
                                                    <div class="news-content">
                                                        <div class="news-text">
                                                            <h3 class="result-title-news">{{ item.title }}</h3>
                                                            <p class="result-description">{{ item.summary || item.description }}</p>
                                                            <div class="news-meta" v-if="item.source || item.date">
                                                                <span v-if="item.source" class="meta-source">{{ item.source }}</span>
                                                                <span v-if="item.date" class="meta-date">{{ item.date }}</span>
                                                            </div>
                                                        </div>
                                                        <img v-if="item.thumbnail" :src="item.thumbnail" :alt="item.title" class="news-thumbnail" loading="lazy">
                                                    </div>
                                                </a>
                                            </article>
                                        </div>
                                    </div>
                                </transition>

                                <div v-if="!loading && !error && searchPerformed && results.length === 0" class="empty-state content-area">
                                    <div class="empty-icon">
                                        <svg width="64" height="64" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <circle cx="32" cy="32" r="28"></circle>
                                            <path d="m52 52-8-8"></path>
                                        </svg>
                                    </div>
                                    <h3 class="empty-title">検索結果が見つかりませんでした</h3>
                                    <p class="empty-description">別のキーワードをお試しください</p>
                                </div>

                                <div v-if="!loading && results.length > 0 && totalPages > 1" class="pagination content-area">
                                    <button @click="changePage(currentPage - 1)" :disabled="currentPage === 1" class="pagination-btn">
                                        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <polyline points="15 18 9 12 15 6"></polyline>
                                        </svg>
                                    </button>
                                    <div class="pagination-numbers">
                                        <button v-for="page in visiblePages" :key="page" @click="changePage(page)" :class="['pagination-number', { 'active': page === currentPage }]">
                                            {{ page }}
                                        </button>
                                    </div>
                                    <button @click="changePage(currentPage + 1)" :disabled="currentPage >= totalPages" class="pagination-btn">
                                        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <polyline points="9 18 15 12 9 6"></polyline>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </main>

                        <aside class="desktop-preview">
                            <div class="preview-header">プレビュー</div>
                            <div v-if="!previewData" class="preview-placeholder">結果を選択するとプレビューが表示されます</div>
                            <div v-else class="preview-content">
                                <h3>{{ previewData.title }}</h3>
                                <p>{{ previewData.description }}</p>
                                <a :href="previewData.url" target="_blank" class="btn btn-primary">開く</a>
                            </div>
                        </aside>
                    </div>
                </div>
            </transition>
        </div>

        <!-- Mobile Tab Bar -->
        <nav class="tab-bar" v-show="currentView !== 'settings'">
            <button v-for="type in searchTypes" :key="type.value" @click="changeSearchType(type.value)" :class="['tab-bar-item', { 'active': currentType === type.value && currentView === 'search' }]">
                <div class="tab-bar-icon" v-html="type.icon"></div>
                <span class="tab-bar-label">{{ type.label }}</span>
            </button>
            <button @click="toggleSettings" :class="['tab-bar-item', { 'active': currentView === 'settings' }]">
                <div class="tab-bar-icon">
                    <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path d="M12 1v6m0 6v6M5.64 5.64l4.24 4.24m4.24 4.24l4.24 4.24M1 12h6m6 0h6M5.64 18.36l4.24-4.24m4.24-4.24l4.24-4.24"></path>
                    </svg>
                </div>
                <span class="tab-bar-label">設定</span>
            </button>
        </nav>

        <!-- Context Menu -->
        <div v-if="showContextMenu" class="context-menu" :style="{ left: contextMenuX + 'px', top: contextMenuY + 'px' }">
            <button class="context-menu-item" @click="openInNewTab">
                <svg class="context-menu-icon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6M15 3h6v6M10 14L21 3"/>
                </svg>
                新しいタブで開く
            </button>
            <button class="context-menu-item" @click="copyLink">
                <svg class="context-menu-icon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
                </svg>
                リンクをコピー
            </button>
        </div>

        <!-- PiP Indicator -->
        <transition name="slide-up">
            <div v-if="pipActive" class="pip-indicator">
                <svg class="pip-indicator-icon" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M0 3.5A1.5 1.5 0 0 1 1.5 2h13A1.5 1.5 0 0 1 16 3.5v9a1.5 1.5 0 0 1-1.5 1.5h-13A1.5 1.5 0 0 1 0 12.5v-9z"/>
                </svg>
                <span class="pip-indicator-text">PiP再生中</span>
                <button class="pip-close" @click="exitPiP">
                    <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 3L3 9M3 3l6 6"/>
                    </svg>
                </button>
            </div>
        </transition>
    </div>

    <script src="js/api.js"></script>
    <script src="js/keyboard.js"></script>
    <script src="js/advanced-features.js"></script>
    <script src="js/animations.js"></script>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    query: '', currentType: 'web', currentPage: 1, totalPages: 10,
                    safesearch: 0, language: 'ja', density: 'normal', viewMode: 'list',
                    results: [], suggestions: [], searchHistory: [],
                    showSuggestions: false, showHistory: false, isSearchFocused: false,
                    loading: false, error: null, searchPerformed: false,
                    showContextMenu: false,
                    contextMenuX: 0, contextMenuY: 0, contextMenuItem: null,
                    previewData: null,
                    tabs: [], activeTabId: null, nextTabId: 1,
                    multiSelectCount: 0, pipActive: false,
                    suggestionDebounceTimer: null,
                    currentView: 'start',
                    animationsEnabled: true,
                    suggestionsEnabled: true,
                    searchTypes: [
                        { label: 'すべて', value: 'web', icon: '<svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8zm7.5-6.923c-.67.204-1.335.82-1.887 1.855A7.97 7.97 0 0 0 5.145 4H7.5V1.077zM4.09 4a9.267 9.267 0 0 1 .64-1.539 6.7 6.7 0 0 1 .597-.933A7.025 7.025 0 0 0 2.255 4H4.09zm-.582 3.5c.03-.877.138-1.718.312-2.5H1.674a6.958 6.958 0 0 0-.656 2.5h2.49zM4.847 5a12.5 12.5 0 0 0-.338 2.5H7.5V5H4.847zM8.5 5v2.5h2.99a12.495 12.495 0 0 0-.337-2.5H8.5zM4.51 8.5a12.5 12.5 0 0 0 .337 2.5H7.5V8.5H4.51zm3.99 0V11h2.653c.187-.765.306-1.608.338-2.5H8.5zM5.145 12c.138.386.295.744.468 1.068.552 1.035 1.218 1.65 1.887 1.855V12H5.145zm.182 2.472a6.696 6.696 0 0 1-.597-.933A9.268 9.268 0 0 1 4.09 12H2.255a7.024 7.024 0 0 0 3.072 2.472zM3.82 11a13.652 13.652 0 0 1-.312-2.5h-2.49c.062.89.291 1.733.656 2.5H3.82zm6.853 3.472A7.024 7.024 0 0 0 13.745 12H11.91a9.27 9.27 0 0 1-.64 1.539 6.688 6.688 0 0 1-.597.933zM8.5 12v2.923c.67-.204 1.335-.82 1.887-1.855.173-.324.33-.682.468-1.068H8.5zm3.68-1h2.146c.365-.767.594-1.61.656-2.5h-2.49a13.65 13.65 0 0 1-.312 2.5zm2.802-3.5a6.959 6.959 0 0 0-.656-2.5H12.18c.174.782.282 1.623.312 2.5h2.49zM11.27 2.461c.247.464.462.98.64 1.539h1.835a7.024 7.024 0 0 0-3.072-2.472c.218.284.418.598.597.933zM10.855 4a7.966 7.966 0 0 0-.468-1.068C9.835 1.897 9.17 1.282 8.5 1.077V4h2.355z"/></svg>' },
                        { label: '画像', value: 'image', icon: '<svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M6.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/><path d="M2.002 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2h-12zm12 1a1 1 0 0 1 1 1v6.5l-3.777-1.947a.5.5 0 0 0-.577.093l-3.71 3.71-2.66-1.772a.5.5 0 0 0-.63.062L1.002 12V3a1 1 0 0 1 1-1h12z"/></svg>' },
                        { label: '動画', value: 'video', icon: '<svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V4zm2-1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4a1 1 0 0 0-1-1H2z"/><path d="M10.8 8 6.5 5.015v5.97L10.8 8z"/></svg>' },
                        { label: 'ニュース', value: 'news', icon: '<svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M0 2.5A1.5 1.5 0 0 1 1.5 1h11A1.5 1.5 0 0 1 14 2.5v10.528c0 .3-.05.654-.238.972h.738a.5.5 0 0 0 .5-.5v-9a.5.5 0 0 1 1 0v9a1.5 1.5 0 0 1-1.5 1.5H1.497A1.497 1.497 0 0 1 0 13.5v-11zM12 14c.37 0 .654-.211.853-.441.092-.106.147-.279.147-.531V2.5a.5.5 0 0 0-.5-.5h-11a.5.5 0 0 0-.5.5v11c0 .278.223.5.497.5H12z"/><path d="M2 3h10v2H2V3zm0 3h4v3H2V6zm0 4h4v1H2v-1zm0 2h4v1H2v-1zm5-6h2v1H7V6zm3 0h2v1h-2V6zM7 8h2v1H7V8zm3 0h2v1h-2V8zm-3 2h2v1H7v-1zm3 0h2v1h-2v-1zm-3 2h2v1H7v-1zm3 0h2v1h-2v-1z"/></svg>' }
                    ],
                    viewModes: [
                        { label: 'リスト', value: 'list', icon: '<svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5z"/></svg>' },
                        { label: 'グリッド', value: 'grid', icon: '<svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M1 2.5A1.5 1.5 0 0 1 2.5 1h3A1.5 1.5 0 0 1 7 2.5v3A1.5 1.5 0 0 1 5.5 7h-3A1.5 1.5 0 0 1 1 5.5v-3zM2.5 2a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3zm6.5.5A1.5 1.5 0 0 1 10.5 1h3A1.5 1.5 0 0 1 15 2.5v3A1.5 1.5 0 0 1 13.5 7h-3A1.5 1.5 0 0 1 9 5.5v-3zm1.5-.5a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3zM1 10.5A1.5 1.5 0 0 1 2.5 9h3A1.5 1.5 0 0 1 7 10.5v3A1.5 1.5 0 0 1 5.5 15h-3A1.5 1.5 0 0 1 1 13.5v-3zm1.5-.5a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3zm6.5.5A1.5 1.5 0 0 1 10.5 9h3a1.5 1.5 0 0 1 1.5 1.5v3a1.5 1.5 0 0 1-1.5 1.5h-3A1.5 1.5 0 0 1 9 13.5v-3zm1.5-.5a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3z"/></svg>' }
                    ],
                    api: null, keyboardNav: null, historyManager: null, tabManager: null, multiSelect: null, pip: null, lenis: null, animationController: null
                }
            },
            computed: {
                visiblePages() {
                    const pages = [], maxVisible = 5, half = Math.floor(maxVisible / 2);
                    let start = Math.max(1, this.currentPage - half), end = Math.min(this.totalPages, start + maxVisible - 1);
                    if (end - start < maxVisible - 1) start = Math.max(1, end - maxVisible + 1);
                    for (let i = start; i <= end; i++) pages.push(i);
                    return pages;
                }
            },
            mounted() {
                this.api = new WholphinAPI();
                this.keyboardNav = new KeyboardNavigation(this);
                this.historyManager = new SearchHistory(this);
                this.tabManager = new TabManager(this);
                this.multiSelect = new MultiSelect(this);
                this.pip = new PictureInPicture();
                
                if (this.animationsEnabled && typeof Lenis !== 'undefined') {
                    this.lenis = new Lenis({
                        duration: 1.2,
                        easing: (t) => Math.min(1, 1.001 - Math.pow(2, -10 * t)),
                        smoothWheel: true,
                        smoothTouch: false
                    });
                    const raf = (time) => {
                        this.lenis.raf(time);
                        requestAnimationFrame(raf);
                    }
                    requestAnimationFrame(raf);
                }
                
                if (this.animationsEnabled && typeof gsap !== 'undefined' && typeof ScrollTrigger !== 'undefined') {
                    gsap.registerPlugin(ScrollTrigger);
                    this.animationController = new AnimationController();
                }
                
                this.tabs = this.tabManager.getTabs();
                this.activeTabId = this.tabManager.activeTabId;
                this.searchHistory = this.historyManager.getRecent();
                
                const urlParams = new URLSearchParams(window.location.search);
                const urlQuery = urlParams.get('q');
                if (urlQuery) {
                    this.query = urlQuery;
                    this.currentView = 'search';
                    this.performSearch();
                }
                document.addEventListener('click', () => { this.showContextMenu = false; this.showHistory = false; });
            },
            methods: {
                toggleSettings() {
                    if (this.currentView === 'settings') {
                        this.currentView = this.searchPerformed ? 'search' : 'start';
                    } else {
                        this.currentView = 'settings';
                    }
                    if (this.animationController) {
                        this.animationController.animateViewTransition(this.currentView);
                    }
                },
                closeSettings() {
                    this.currentView = this.searchPerformed ? 'search' : 'start';
                    if (this.animationController) {
                        this.animationController.animateViewTransition(this.currentView);
                    }
                },
                handleStartSearchFocus() {
                    this.isSearchFocused = true;
                    if (this.suggestionsEnabled && this.suggestions.length > 0) {
                        this.showSuggestions = true;
                    }
                },
                handleSearchFocus() {
                    this.isSearchFocused = true;
                    if (!this.query.trim() && this.searchHistory.length > 0) {
                        this.showHistory = true;
                    } else if (this.suggestionsEnabled && this.suggestions.length > 0) {
                        this.showSuggestions = true;
                    }
                },
                async handleSearchInput() {
                    if (this.suggestionDebounceTimer) clearTimeout(this.suggestionDebounceTimer);
                    this.showHistory = false;
                    if (!this.query.trim() || !this.suggestionsEnabled) { this.suggestions = []; this.showSuggestions = false; return; }
                    this.suggestionDebounceTimer = setTimeout(async () => {
                        try {
                            const response = await this.api.search({ q: this.query, type: 'suggest', lang: this.language });
                            this.suggestions = response.suggestions || [];
                            if (this.isSearchFocused && this.suggestions.length > 0) this.showSuggestions = true;
                        } catch (err) { console.error('Suggestion error:', err); this.suggestions = []; }
                    }, 300);
                },
                handleSearchBlur() { this.isSearchFocused = false; setTimeout(() => { this.showSuggestions = false; }, 200); },
                performSearchFromStart() {
                    if (!this.query.trim()) return;
                    this.currentView = 'search';
                    this.performSearch();
                },
                async performSearch() {
                    if (!this.query.trim()) return;
                    this.showSuggestions = false; this.showHistory = false;
                    this.loading = true; this.error = null; this.searchPerformed = true; this.results = [];
                    this.keyboardNav.reset(); this.historyManager.add(this.query);
                    this.searchHistory = this.historyManager.getRecent();
                    try {
                        const response = await this.api.search({ q: this.query, type: this.currentType, page: this.currentPage, safesearch: this.safesearch, lang: this.language });
                        const url = new URL(window.location); url.searchParams.set('q', this.query); window.history.pushState({}, '', url);
                        this.results = response.results || [];
                        if (response.pagination) this.totalPages = response.pagination.totalPages || 10;
                        
                        if (this.animationController && this.animationsEnabled) {
                            this.$nextTick(() => {
                                this.animationController.animateResults();
                            });
                        }
                    } catch (err) { this.error = err instanceof WholphinAPIError ? err.message : 'ネットワークエラー'; } finally { this.loading = false; }
                },
                changeSearchType(type) {
                    if (this.currentType === type) return;
                    this.currentType = type; this.currentPage = 1;
                    this.currentView = 'search';
                    if (this.query.trim() && this.searchPerformed) this.performSearch();
                },
                changePage(page) { 
                    if (page < 1 || page > this.totalPages) return; 
                    this.currentPage = page; 
                    this.performSearch(); 
                    if (this.lenis) {
                        this.lenis.scrollTo(0, { duration: 0.8 });
                    } else {
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }
                },
                selectSuggestion(suggestion) { this.query = suggestion; this.showSuggestions = false; this.suggestions = []; this.performSearchFromStart(); },
                selectHistory(item) { this.query = item.query; this.currentType = item.type; this.showHistory = false; this.currentView = 'search'; this.performSearch(); },
                deleteHistory(query) { this.historyManager.remove(query); this.searchHistory = this.historyManager.getRecent(); },
                clearHistory() { this.historyManager.clear(); this.searchHistory = []; this.showHistory = false; },
                clearHistoryConfirm() {
                    if (confirm('検索履歴をすべて削除しますか?')) {
                        this.clearHistory();
                    }
                },
                handleFaviconError(event) { event.target.style.display = 'none'; const fallback = event.target.nextElementSibling; if (fallback?.classList.contains('result-favicon-fallback')) fallback.style.display = 'flex'; },
                extractDomain(url) { try { return new URL(url).hostname.replace('www.', ''); } catch { return url; } },
                formatViews(views) { if (typeof views === 'string') return views; if (views >= 1000000) return (views / 1000000).toFixed(1) + 'M'; if (views >= 1000) return (views / 1000).toFixed(1) + 'K'; return views; },
                formatTimestamp(ts) { const diff = Date.now() - ts, mins = Math.floor(diff / 60000), hrs = Math.floor(diff / 3600000), days = Math.floor(diff / 86400000); if (mins < 60) return mins + '分前'; if (hrs < 24) return hrs + '時間前'; return days + '日前'; },
                getTypeLabel(type) { const t = this.searchTypes.find(t => t.value === type); return t ? t.label : type; },
                showContextMenuFor(item, event) { this.contextMenuItem = item; this.contextMenuX = event.clientX; this.contextMenuY = event.clientY; this.showContextMenu = true; },
                openInNewTab() { if (this.contextMenuItem) window.open(this.contextMenuItem.url, '_blank', 'noopener,noreferrer'); this.showContextMenu = false; },
                copyLink() { if (this.contextMenuItem) navigator.clipboard.writeText(this.contextMenuItem.url); this.showContextMenu = false; },
                createNewTab() { const tab = this.tabManager.createTab('新規検索', true); this.tabs = this.tabManager.getTabs(); this.activeTabId = tab.id; },
                switchTab(tabId) { this.tabManager.switchTab(tabId); this.tabs = this.tabManager.getTabs(); this.activeTabId = this.tabManager.activeTabId; },
                closeTab(tabId) { this.tabManager.closeTab(tabId); this.tabs = this.tabManager.getTabs(); this.activeTabId = this.tabManager.activeTabId; },
                async togglePiP(item) { if (this.pipActive) { await this.pip.exitPiP(); this.pipActive = false; } else { const success = await this.pip.requestPiP(item.url, item.title); if (success) this.pipActive = true; } },
                async exitPiP() { await this.pip.exitPiP(); this.pipActive = false; }
            }
        }).mount('#app');
    </script>
</body>
</html>