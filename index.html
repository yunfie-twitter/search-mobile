<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="description" content="Wholphin Search - プライバシーを重視した検索エンジン">
    <meta name="theme-color" content="#3b82f6">
    <title>Wholphin Search</title>
    
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%233b82f6'/%3E%3Cpath d='M30 45 Q50 30 70 45 T70 65 Q50 80 30 65 Z' fill='white'/%3E%3C/svg%3E">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%233b82f6'/%3E%3Cpath d='M30 45 Q50 30 70 45 T70 65 Q50 80 30 65 Z' fill='white'/%3E%3C/svg%3E">
    
    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="css/design-system.css">
    <link rel="stylesheet" href="css/layout.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/desktop.css">
    <link rel="stylesheet" href="css/start-page.css">
    <link rel="stylesheet" href="css/settings-page.css">
    <link rel="stylesheet" href="css/mobile-search.css">
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@studio-freight/lenis@1.0.29/bundled/lenis.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/ScrollTrigger.min.js"></script>
</head>
<body>
    <div id="app">
        <!-- 省略: Mobile Search Overlay, History Modal, Desktop Sidebar 等は前回と同じ -->
        
        <!-- Search Type Bar - タブバー上部固定 -->
        <div 
            v-if="currentView === 'search' && !showMobileSearch" 
            class="search-type-bar"
            :class="{ 'hidden': isScrollingDown || isFullscreenMode }"
            ref="searchTypeBar"
        >
            <div class="search-type-chips">
                <button
                    v-for="type in searchTypes"
                    :key="type.value"
                    @click="changeSearchType(type.value)"
                    :class="['search-type-chip', { 'active': currentType === type.value }]"
                    :aria-current="currentType === type.value ? 'page' : undefined"
                >
                    <div class="search-type-chip-icon" v-html="type.icon"></div>
                    <span>{{ type.label }}</span>
                </button>
            </div>
        </div>

        <!-- Mobile Tab Bar -->
        <nav 
            class="tab-bar" 
            v-show="currentView !== 'settings' && !showMobileSearch"
            :class="{ 'hidden': isScrollingDown || isFullscreenMode }"
            ref="tabBar"
        >
            <button 
                class="tab-bar-item"
                :class="{ 'active': currentView === 'start' }"
                @click="goToHome"
                aria-label="ホーム"
                :aria-current="currentView === 'start' ? 'page' : undefined"
            >
                <div class="tab-bar-icon">
                    <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                        <polyline points="9 22 9 12 15 12 15 22"></polyline>
                    </svg>
                </div>
                <span class="tab-bar-label">ホーム</span>
            </button>
            
            <button 
                class="tab-bar-fab" 
                @click="handleFABClick"
                @mousedown="handleFABMouseDown"
                @mouseup="handleFABMouseUp"
                @mouseleave="handleFABMouseUp"
                @touchstart="handleFABTouchStart"
                @touchend="handleFABTouchEnd"
                aria-label="検索"
                ref="fabButton"
            >
                <svg class="tab-bar-fab-icon" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.35-4.35"></path>
                </svg>
            </button>
            
            <button 
                class="tab-bar-item"
                @click="openHistoryModal"
                aria-label="履歴"
            >
                <div class="tab-bar-icon">
                    <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="10"></circle>
                        <polyline points="12 6 12 12 16 14"></polyline>
                    </svg>
                </div>
                <span class="tab-bar-label">履歴</span>
                <span v-if="searchHistory.length > 0" class="tab-bar-badge">{{ searchHistory.length > 99 ? '99+' : searchHistory.length }}</span>
            </button>
        </nav>

        <!-- 残りのコンテンツ(start-page, settings-page, search-view等)は前回と同じ -->
    </div>

    <script src="js/api.js"></script>
    <script src="js/keyboard.js"></script>
    <script src="js/advanced-features.js"></script>
    <script src="js/animations.js"></script>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    // 既存のデータ
                    query: '', currentType: 'web', currentPage: 1, totalPages: 10,
                    safesearch: 0, language: 'ja', density: 'normal', viewMode: 'list',
                    results: [], suggestions: [], searchHistory: [],
                    showSuggestions: false, showHistory: false, isSearchFocused: false,
                    loading: false, error: null, searchPerformed: false,
                    showContextMenu: false, contextMenuX: 0, contextMenuY: 0, contextMenuItem: null,
                    previewData: null, tabs: [], activeTabId: null, nextTabId: 1,
                    multiSelectCount: 0, pipActive: false, suggestionDebounceTimer: null,
                    currentView: 'start', animationsEnabled: true, suggestionsEnabled: true,
                    showMobileSearch: false, showHistoryModal: false,
                    mobileSuggestions: [], mobileSearchDebounceTimer: null, isMobile: false,
                    // 新規追加
                    isScrollingDown: false,
                    isFullscreenMode: false,
                    lastScrollY: 0,
                    fabLongPressTimer: null,
                    historySortMode: 'recent',
                    searchTypes: [
                        { label: 'ウェブ', value: 'web', icon: '<svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8zm7.5-6.923c-.67.204-1.335.82-1.887 1.855A7.97 7.97 0 0 0 5.145 4H7.5V1.077zM4.09 4a9.267 9.267 0 0 1 .64-1.539 6.7 6.7 0 0 1 .597-.933A7.025 7.025 0 0 0 2.255 4H4.09zm-.582 3.5c.03-.877.138-1.718.312-2.5H1.674a6.958 6.958 0 0 0-.656 2.5h2.49zM4.847 5a12.5 12.5 0 0 0-.338 2.5H7.5V5H4.847zM8.5 5v2.5h2.99a12.495 12.495 0 0 0-.337-2.5H8.5zM4.51 8.5a12.5 12.5 0 0 0 .337 2.5H7.5V8.5H4.51zm3.99 0V11h2.653c.187-.765.306-1.608.338-2.5H8.5zM5.145 12c.138.386.295.744.468 1.068.552 1.035 1.218 1.65 1.887 1.855V12H5.145zm.182 2.472a6.696 6.696 0 0 1-.597-.933A9.268 9.268 0 0 1 4.09 12H2.255a7.024 7.024 0 0 0 3.072 2.472zM3.82 11a13.652 13.652 0 0 1-.312-2.5h-2.49c.062.89.291 1.733.656 2.5H3.82zm6.853 3.472A7.024 7.024 0 0 0 13.745 12H11.91a9.27 9.27 0 0 1-.64 1.539 6.688 6.688 0 0 1-.597.933zM8.5 12v2.923c.67-.204 1.335-.82 1.887-1.855.173-.324.33-.682.468-1.068H8.5zm3.68-1h2.146c.365-.767.594-1.61.656-2.5h-2.49a13.65 13.65 0 0 1-.312 2.5zm2.802-3.5a6.959 6.959 0 0 0-.656-2.5H12.18c.174.782.282 1.623.312 2.5h2.49zM11.27 2.461c.247.464.462.98.64 1.539h1.835a7.024 7.024 0 0 0-3.072-2.472c.218.284.418.598.597.933zM10.855 4a7.966 7.966 0 0 0-.468-1.068C9.835 1.897 9.17 1.282 8.5 1.077V4h2.355z"/></svg>' },
                        { label: '画像', value: 'image', icon: '<svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M6.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/><path d="M2.002 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2h-12zm12 1a1 1 0 0 1 1 1v6.5l-3.777-1.947a.5.5 0 0 0-.577.093l-3.71 3.71-2.66-1.772a.5.5 0 0 0-.63.062L1.002 12V3a1 1 0 0 1 1-1h12z"/></svg>' },
                        { label: '動画', value: 'video', icon: '<svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V4zm2-1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4a1 1 0 0 0-1-1H2z"/><path d="M10.8 8 6.5 5.015v5.97L10.8 8z"/></svg>' },
                        { label: 'ニュース', value: 'news', icon: '<svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M0 2.5A1.5 1.5 0 0 1 1.5 1h11A1.5 1.5 0 0 1 14 2.5v10.528c0 .3-.05.654-.238.972h.738a.5.5 0 0 0 .5-.5v-9a.5.5 0 0 1 1 0v9a1.5 1.5 0 0 1-1.5 1.5H1.497A1.497 1.497 0 0 1 0 13.5v-11zM12 14c.37 0 .654-.211.853-.441.092-.106.147-.279.147-.531V2.5a.5.5 0 0 0-.5-.5h-11a.5.5 0 0 0-.5.5v11c0 .278.223.5.497.5H12z"/><path d="M2 3h10v2H2V3zm0 3h4v3H2V6zm0 4h4v1H2v-1zm0 2h4v1H2v-1zm5-6h2v1H7V6zm3 0h2v1h-2V6zM7 8h2v1H7V8zm3 0h2v1h-2V8zm-3 2h2v1H7v-1zm3 0h2v1h-2v-1zm-3 2h2v1H7v-1zm3 0h2v1h-2v-1z"/></svg>' }
                    ],
                    viewModes: [
                        { label: 'リスト', value: 'list', icon: '<svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5z"/></svg>' },
                        { label: 'グリッド', value: 'grid', icon: '<svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M1 2.5A1.5 1.5 0 0 1 2.5 1h3A1.5 1.5 0 0 1 7 2.5v3A1.5 1.5 0 0 1 5.5 7h-3A1.5 1.5 0 0 1 1 5.5v-3zM2.5 2a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3zm6.5.5A1.5 1.5 0 0 1 10.5 1h3A1.5 1.5 0 0 1 15 2.5v3A1.5 1.5 0 0 1 13.5 7h-3A1.5 1.5 0 0 1 9 5.5v-3zm1.5-.5a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3zM1 10.5A1.5 1.5 0 0 1 2.5 9h3A1.5 1.5 0 0 1 7 10.5v3A1.5 1.5 0 0 1 5.5 15h-3A1.5 1.5 0 0 1 1 13.5v-3zm1.5-.5a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3zm6.5.5A1.5 1.5 0 0 1 10.5 9h3a1.5 1.5 0 0 1 1.5 1.5v3a1.5 1.5 0 0 1-1.5 1.5h-3A1.5 1.5 0 0 1 9 13.5v-3zm1.5-.5a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3z"/></svg>' }
                    ],
                    api: null, keyboardNav: null, historyManager: null, tabManager: null, multiSelect: null, pip: null, lenis: null, animationController: null
                }
            },
            computed: {
                visiblePages() {
                    const pages = [], maxVisible = 5, half = Math.floor(maxVisible / 2);
                    let start = Math.max(1, this.currentPage - half), end = Math.min(this.totalPages, start + maxVisible - 1);
                    if (end - start < maxVisible - 1) start = Math.max(1, end - maxVisible + 1);
                    for (let i = start; i <= end; i++) pages.push(i);
                    return pages;
                },
                sortedHistory() {
                    if (this.historySortMode === 'recent') {
                        return [...this.searchHistory].sort((a, b) => b.timestamp - a.timestamp);
                    } else if (this.historySortMode === 'frequent') {
                        return [...this.searchHistory].sort((a, b) => (b.count || 1) - (a.count || 1));
                    } else if (this.historySortMode === 'type') {
                        return [...this.searchHistory].sort((a, b) => a.type.localeCompare(b.type));
                    }
                    return this.searchHistory;
                }
            },
            mounted() {
                this.isMobile = window.innerWidth < 768;
                window.addEventListener('resize', () => {
                    this.isMobile = window.innerWidth < 768;
                });
                
                // スクロール検出
                let ticking = false;
                window.addEventListener('scroll', () => {
                    if (!ticking) {
                        window.requestAnimationFrame(() => {
                            this.handleScroll();
                            ticking = false;
                        });
                        ticking = true;
                    }
                });

                this.api = new WholphinAPI();
                this.keyboardNav = new KeyboardNavigation(this);
                this.historyManager = new SearchHistory(this);
                this.tabManager = new TabManager(this);
                this.multiSelect = new MultiSelect(this);
                this.pip = new PictureInPicture();
                
                if (this.animationsEnabled && typeof Lenis !== 'undefined') {
                    this.initLenis();
                }
                
                if (this.animationsEnabled && typeof gsap !== 'undefined' && typeof ScrollTrigger !== 'undefined') {
                    gsap.registerPlugin(ScrollTrigger);
                    this.animationController = new AnimationController();
                }
                
                this.tabs = this.tabManager.getTabs();
                this.activeTabId = this.tabManager.activeTabId;
                this.searchHistory = this.historyManager.getRecent();
                
                const urlParams = new URLSearchParams(window.location.search);
                const urlQuery = urlParams.get('q');
                if (urlQuery) {
                    this.query = urlQuery;
                    this.currentView = 'search';
                    this.performSearch();
                }
                document.addEventListener('click', () => { this.showContextMenu = false; this.showHistory = false; });
            },
            methods: {
                handleScroll() {
                    const currentScrollY = window.scrollY;
                    if (currentScrollY > this.lastScrollY && currentScrollY > 100) {
                        this.isScrollingDown = true;
                    } else {
                        this.isScrollingDown = false;
                    }
                    this.lastScrollY = currentScrollY;
                },
                handleFABClick() {
                    if (this.isMobile) {
                        this.openMobileSearch();
                    } else {
                        this.currentView = 'start';
                    }
                },
                handleFABMouseDown() {
                    this.fabLongPressTimer = setTimeout(() => {
                        this.triggerVoiceSearch();
                    }, 600);
                },
                handleFABMouseUp() {
                    if (this.fabLongPressTimer) {
                        clearTimeout(this.fabLongPressTimer);
                        this.fabLongPressTimer = null;
                    }
                },
                handleFABTouchStart() {
                    this.fabLongPressTimer = setTimeout(() => {
                        this.triggerVoiceSearch();
                        if (navigator.vibrate) navigator.vibrate(50);
                    }, 600);
                },
                handleFABTouchEnd() {
                    if (this.fabLongPressTimer) {
                        clearTimeout(this.fabLongPressTimer);
                        this.fabLongPressTimer = null;
                    }
                },
                triggerVoiceSearch() {
                    if (this.$refs.fabButton) {
                        this.$refs.fabButton.classList.add('long-press');
                        setTimeout(() => {
                            this.$refs.fabButton.classList.remove('long-press');
                        }, 300);
                    }
                    alert('音声検索機能は開発中です');
                },
                cycleHistorySort() {
                    const modes = ['recent', 'frequent', 'type'];
                    const currentIndex = modes.indexOf(this.historySortMode);
                    this.historySortMode = modes[(currentIndex + 1) % modes.length];
                },
                getHistorySortLabel() {
                    const labels = { recent: '最新順', frequent: '頻度順', type: 'タイプ別' };
                    return labels[this.historySortMode];
                },
                // 既存のメソッドはそのまま...
                initLenis() { /* 省略 */ },
                destroyLenis() { /* 省略 */ },
                toggleAnimations() { /* 省略 */ },
                goToHome() { /* 省略 */ },
                openHistoryModal() { this.showHistoryModal = true; },
                closeHistoryModal() { this.showHistoryModal = false; },
                selectHistoryFromModal(item) { /* 省略 */ },
                openMobileSearch() { /* 省略 */ },
                closeMobileSearch() { /* 省略 */ },
                clearMobileSearch() { /* 省略 */ },
                handleMobileSearchInput() { /* 省略 */ },
                selectMobileSuggestion(suggestion) { /* 省略 */ },
                selectMobileHistory(item) { /* 省略 */ },
                performMobileSearch() { /* 省略 */ },
                toggleSettings() { /* 省略 */ },
                closeSettings() { /* 省略 */ },
                handleStartSearchFocus() { /* 省略 */ },
                handleSearchFocus() { /* 省略 */ },
                handleSearchInput() { /* 省略 */ },
                handleSearchBlur() { /* 省略 */ },
                performSearchFromStart() { /* 省略 */ },
                async performSearch() { /* 省略 */ },
                changeSearchType(type) {
                    if (this.currentType === type && this.currentView === 'search') {
                        if (this.query.trim()) { this.currentPage = 1; this.performSearch(); }
                        return;
                    }
                    this.currentType = type; this.currentPage = 1; this.currentView = 'search';
                    if (this.query.trim()) this.performSearch();
                },
                changePage(page) { /* 省略 */ },
                selectSuggestion(suggestion) { /* 省略 */ },
                selectHistory(item) { /* 省略 */ },
                deleteHistory(query) { /* 省略 */ },
                clearHistory() { /* 省略 */ },
                clearHistoryConfirm() { /* 省略 */ },
                handleFaviconError(event) { /* 省略 */ },
                extractDomain(url) { /* 省略 */ },
                formatViews(views) { /* 省略 */ },
                formatTimestamp(ts) { /* 省略 */ },
                getTypeLabel(type) { /* 省略 */ },
                showContextMenuFor(item, event) { /* 省略 */ },
                openInNewTab() { /* 省略 */ },
                copyLink() { /* 省略 */ },
                createNewTab() { /* 省略 */ },
                switchTab(tabId) { /* 省略 */ },
                closeTab(tabId) { /* 省略 */ },
                async togglePiP(item) { /* 省略 */ },
                async exitPiP() { /* 省略 */ }
            }
        }).mount('#app');
    </script>
</body>
</html>