<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="description" content="Wholphin Search - プライバシーを重視したモバイル検索エンジン">
    <meta name="theme-color" content="#0369a1">
    <title>Wholphin Search</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%230369a1'/%3E%3Cpath d='M30 45 Q50 30 70 45 T70 65 Q50 80 30 65 Z' fill='white'/%3E%3C/svg%3E">
    <link rel="icon" type="image/png" sizes="32x32" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%230369a1'/%3E%3Cpath d='M30 45 Q50 30 70 45 T70 65 Q50 80 30 65 Z' fill='white'/%3E%3C/svg%3E">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%230369a1'/%3E%3Cpath d='M30 45 Q50 30 70 45 T70 65 Q50 80 30 65 Z' fill='white'/%3E%3C/svg%3E">
    
    <!-- CSS -->
    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/fonts.css">
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/layout.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/utilities.css">
    
    <!-- Vue.js 3 CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
</head>
<body>
    <div id="app">
        <!-- Header -->
        <header class="mobile-header">
            <div class="flex items-center justify-between">
                <h1 class="text-3xl font-extrabold text-primary" style="margin-bottom: 0;">Wholphin Search</h1>
                <button class="btn-icon btn-ghost" @click="showSettings = !showSettings" aria-label="設定">
                    <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path d="M12 1v6m0 6v6M5.64 5.64l4.24 4.24m4.24 4.24l4.24 4.24M1 12h6m6 0h6M5.64 18.36l4.24-4.24m4.24-4.24l4.24-4.24"></path>
                    </svg>
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="container py-4">
            <!-- Search Box -->
            <div class="search-box mb-6">
                <input 
                    type="search" 
                    class="search-input" 
                    v-model="query"
                    @keyup.enter="performSearch"
                    placeholder="検索ワードを入力..."
                    aria-label="検索"
                >
                <button class="search-button" @click="performSearch" aria-label="検索実行">
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.35-4.35"></path>
                    </svg>
                </button>
            </div>

            <!-- Search Type Tabs -->
            <div class="flex gap-2 mb-6 scroll-x pb-2">
                <button 
                    v-for="type in searchTypes" 
                    :key="type.value"
                    @click="changeSearchType(type.value)"
                    :class="['btn', 'btn-sm', currentType === type.value ? 'btn-primary' : 'btn-ghost']"
                >
                    {{ type.label }}
                </button>
            </div>

            <!-- Settings Panel -->
            <transition name="slide-down">
                <div v-if="showSettings" class="card mb-6 settings-panel">
                    <div class="card-header">検索設定</div>
                    <div class="card-body stack-sm">
                        <div>
                            <label class="block text-sm font-medium mb-2">セーフサーチ</label>
                            <select v-model.number="safesearch" class="input input-sm">
                                <option :value="0">無効</option>
                                <option :value="1">標準</option>
                                <option :value="2">厳格</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">言語</label>
                            <select v-model="language" class="input input-sm">
                                <option value="ja">日本語</option>
                                <option value="en">English</option>
                            </select>
                        </div>
                    </div>
                </div>
            </transition>

            <!-- Loading State with Skeleton -->
            <div v-if="loading">
                <div class="stack">
                    <div class="skeleton skeleton-card" v-for="i in 3" :key="i"></div>
                </div>
            </div>

            <!-- Error State -->
            <div v-if="error" class="alert alert-error mb-6">
                <strong>エラーが発生しました:</strong> {{ error }}
            </div>

            <!-- Results -->
            <transition name="fade" mode="out-in">
                <div v-if="!loading && results.length > 0" :key="currentType" class="stack" :class="getResultStackClass()">
                    <!-- Web Results with Favicon -->
                    <div v-if="currentType === 'web'" class="stack-web">
                        <article v-for="(item, index) in results" :key="index" class="card">
                            <a :href="item.url" target="_blank" rel="noopener noreferrer" class="block">
                                <div class="result-header">
                                    <img 
                                        v-if="item.favicon" 
                                        :src="item.favicon" 
                                        :alt="item.title + ' favicon'"
                                        class="result-favicon"
                                        loading="lazy"
                                        @error="handleFaviconError($event)"
                                    >
                                    <div class="result-favicon-fallback" v-else>
                                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                            <path d="M8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0zM4.5 7.5a.5.5 0 0 1 0-1h5.793L8.146 4.354a.5.5 0 1 1 .708-.708l3 3a.5.5 0 0 1 0 .708l-3 3a.5.5 0 0 1-.708-.708L10.293 7.5H4.5z"/>
                                        </svg>
                                    </div>
                                    <h3 class="text-lg font-semibold text-primary result-title">{{ item.title }}</h3>
                                </div>
                                <p class="text-sm text-secondary mb-2 text-description">{{ item.summary || item.description }}</p>
                                <p class="text-xs text-tertiary truncate result-url">{{ item.url }}</p>
                            </a>
                        </article>
                    </div>

                    <!-- Image Results -->
                    <div v-if="currentType === 'image'" class="grid grid-cols-2 md:grid-cols-3">
                        <a 
                            v-for="(item, index) in results" 
                            :key="index" 
                            :href="item.url" 
                            target="_blank" 
                            rel="noopener noreferrer"
                            class="card p-0 overflow-hidden"
                        >
                            <img :src="item.thumbnail" :alt="item.title" class="w-full h-48 object-cover" loading="lazy">
                            <div class="p-2">
                                <p class="text-sm truncate">{{ item.title }}</p>
                            </div>
                        </a>
                    </div>

                    <!-- Video Results -->
                    <div v-if="currentType === 'video'" class="stack-video">
                        <article v-for="(item, index) in results" :key="index" class="card">
                            <a :href="item.url" target="_blank" rel="noopener noreferrer" class="block">
                                <div v-if="item.thumbnail" class="mb-3">
                                    <img :src="item.thumbnail" :alt="item.title" class="w-full rounded-lg" loading="lazy">
                                </div>
                                <h3 class="text-lg font-semibold mb-2 text-primary">{{ item.title }}</h3>
                                <p class="text-sm text-secondary mb-2 text-description">{{ item.summary || item.description }}</p>
                                <div class="flex items-center gap-2 text-xs text-tertiary">
                                    <span v-if="item.duration">{{ item.duration }}</span>
                                    <span v-if="item.views">{{ item.views }} 回視聴</span>
                                </div>
                            </a>
                        </article>
                    </div>

                    <!-- News Results -->
                    <div v-if="currentType === 'news'" class="stack-news">
                        <article v-for="(item, index) in results" :key="index" class="card">
                            <a :href="item.url" target="_blank" rel="noopener noreferrer" class="block">
                                <div class="flex gap-3">
                                    <img v-if="item.thumbnail" :src="item.thumbnail" :alt="item.title" class="w-24 h-24 rounded object-cover" loading="lazy">
                                    <div class="flex-1">
                                        <h3 class="text-base font-semibold mb-1 text-primary">{{ item.title }}</h3>
                                        <p class="text-sm text-secondary mb-2 line-clamp-2 text-description">{{ item.summary || item.description }}</p>
                                        <div class="flex items-center gap-2 text-xs text-tertiary">
                                            <span v-if="item.source">{{ item.source }}</span>
                                            <span v-if="item.date">{{ item.date }}</span>
                                        </div>
                                    </div>
                                </div>
                            </a>
                        </article>
                    </div>

                    <!-- Suggestions -->
                    <div v-if="currentType === 'suggest'" class="stack-sm">
                        <button 
                            v-for="(item, index) in results" 
                            :key="index" 
                            @click="selectSuggestion(item)"
                            class="card text-left transition"
                        >
                            {{ item }}
                        </button>
                    </div>

                    <!-- Panel Info -->
                    <div v-if="currentType === 'panel' && panelData" class="card">
                        <div class="card-header">{{ panelData.title }}</div>
                        <div class="card-body">
                            <img v-if="panelData.image" :src="panelData.image" :alt="panelData.title" class="w-full rounded-lg mb-4" loading="lazy">
                            <p class="text-secondary text-description">{{ panelData.description }}</p>
                            <div v-if="panelData.facts" class="mt-4 stack-sm">
                                <div v-for="(fact, index) in panelData.facts" :key="index" class="flex justify-between border-b pb-2">
                                    <span class="font-medium">{{ fact.label }}</span>
                                    <span class="text-secondary">{{ fact.value }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </transition>

            <!-- Empty State -->
            <div v-if="!loading && !error && searchPerformed && results.length === 0" class="text-center py-12">
                <p class="text-secondary">検索結果が見つかりませんでした</p>
            </div>

            <!-- Pagination -->
            <div v-if="!loading && results.length > 0 && totalPages > 1" class="flex justify-center gap-2 mt-8 safe-all">
                <button 
                    @click="changePage(currentPage - 1)"
                    :disabled="currentPage === 1"
                    class="btn btn-outline btn-sm"
                >
                    前へ
                </button>
                <span class="btn btn-ghost btn-sm">{{ currentPage }} / {{ totalPages }}</span>
                <button 
                    @click="changePage(currentPage + 1)"
                    :disabled="currentPage >= totalPages"
                    class="btn btn-outline btn-sm"
                >
                    次へ
                </button>
            </div>
        </main>

        <!-- Footer -->
        <footer class="mobile-footer">
            <div class="text-center text-xs text-tertiary">
                <p>Powered by <a href="https://api.p2pear.asia/" target="_blank" class="text-primary">Wholphin Search API</a></p>
            </div>
        </footer>
    </div>

    <!-- API Client -->
    <script src="js/api.js"></script>

    <!-- Vue App -->
    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    query: '',
                    currentType: 'web',
                    currentPage: 1,
                    totalPages: 10,
                    safesearch: 0,
                    language: 'ja',
                    results: [],
                    panelData: null,
                    loading: false,
                    error: null,
                    searchPerformed: false,
                    showSettings: false,
                    searchTypes: [
                        { label: 'Web', value: 'web' },
                        { label: '画像', value: 'image' },
                        { label: '動画', value: 'video' },
                        { label: 'ニュース', value: 'news' },
                        { label: 'サジェスト', value: 'suggest' },
                        { label: 'パネル', value: 'panel' }
                    ],
                    api: null
                }
            },
            mounted() {
                // Initialize API client
                this.api = new WholphinAPI();
                
                // Load query from URL if exists
                const urlParams = new URLSearchParams(window.location.search);
                const urlQuery = urlParams.get('q');
                if (urlQuery) {
                    this.query = urlQuery;
                    this.performSearch();
                }
            },
            methods: {
                async performSearch() {
                    if (!this.query.trim()) {
                        return;
                    }

                    this.loading = true;
                    this.error = null;
                    this.searchPerformed = true;
                    this.results = [];
                    this.panelData = null;

                    try {
                        const options = {
                            q: this.query,
                            type: this.currentType,
                            page: this.currentPage,
                            safesearch: this.safesearch,
                            lang: this.language
                        };

                        const response = await this.api.search(options);
                        
                        // Update URL with search query
                        const url = new URL(window.location);
                        url.searchParams.set('q', this.query);
                        window.history.pushState({}, '', url);

                        // Process results based on type
                        if (this.currentType === 'suggest') {
                            this.results = response.suggestions || [];
                        } else if (this.currentType === 'panel') {
                            this.panelData = response.panel || null;
                        } else {
                            this.results = response.results || [];
                            if (response.pagination) {
                                this.totalPages = response.pagination.totalPages || 10;
                            }
                        }
                    } catch (err) {
                        if (err instanceof WholphinAPIError) {
                            this.error = err.message;
                            if (err.details && err.details.errors) {
                                this.error += ': ' + err.details.errors.join(', ');
                            }
                        } else {
                            this.error = 'ネットワークエラーが発生しました';
                        }
                        console.error('Search error:', err);
                    } finally {
                        this.loading = false;
                    }
                },
                changeSearchType(type) {
                    this.currentType = type;
                    this.currentPage = 1;
                    if (this.query.trim() && this.searchPerformed) {
                        this.performSearch();
                    }
                },
                changePage(page) {
                    if (page < 1 || page > this.totalPages) {
                        return;
                    }
                    this.currentPage = page;
                    this.performSearch();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                },
                selectSuggestion(suggestion) {
                    this.query = suggestion;
                    this.currentType = 'web';
                    this.performSearch();
                },
                handleFaviconError(event) {
                    // Hide broken favicon image
                    event.target.style.display = 'none';
                    // Show fallback icon
                    const fallback = event.target.nextElementSibling;
                    if (fallback && fallback.classList.contains('result-favicon-fallback')) {
                        fallback.style.display = 'flex';
                    }
                },
                getResultStackClass() {
                    const classMap = {
                        'web': 'stack-web',
                        'image': '',
                        'video': 'stack-video',
                        'news': 'stack-news',
                        'suggest': 'stack-sm',
                        'panel': ''
                    };
                    return classMap[this.currentType] || 'stack';
                }
            }
        }).mount('#app');
    </script>
    
    <style>
        /* Vue transitions */
        .fade-enter-active, .fade-leave-active {
            transition: opacity 0.3s ease;
        }
        .fade-enter-from, .fade-leave-to {
            opacity: 0;
        }
        
        .slide-down-enter-active, .slide-down-leave-active {
            transition: all 0.3s ease;
        }
        .slide-down-enter-from {
            opacity: 0;
            transform: translateY(-10px);
        }
        .slide-down-leave-to {
            opacity: 0;
            transform: translateY(-10px);
        }
        
        /* Result header with favicon */
        .result-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        .result-favicon {
            width: 18px;
            height: 18px;
            flex-shrink: 0;
            border-radius: 3px;
            object-fit: contain;
        }
        
        .result-favicon-fallback {
            width: 18px;
            height: 18px;
            flex-shrink: 0;
            display: none;
            align-items: center;
            justify-content: center;
            background-color: var(--color-bg-tertiary);
            border-radius: 3px;
            color: var(--color-text-tertiary);
        }
        
        .result-title {
            margin-bottom: 0;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        
        .result-url {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
    </style>
</body>
</html>
